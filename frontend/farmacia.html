<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmacAI - Cat√°logo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .search-box {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            width: 300px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            border-color: #667eea;
        }

        .content-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #666;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .product-name {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .product-sku {
            font-size: 13px;
            color: #7f8c8d;
            font-weight: 500;
        }

        .product-category {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .product-details {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .detail-label {
            color: #6c757d;
            font-size: 13px;
            font-weight: 600;
        }

        .detail-value {
            color: #2c3e50;
            font-size: 14px;
            font-weight: 600;
        }

        .price {
            color: #27ae60;
            font-size: 20px;
        }

        .stock-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .stock-high { background: #d4edda; color: #155724; }
        .stock-medium { background: #fff3cd; color: #856404; }
        .stock-low { background: #f8d7da; color: #721c24; }
        .stock-out { background: #e2e3e5; color: #383d41; }

        .expiry-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #856404;
        }

        .expiry-critical {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #f8f9fa;
            color: #495057;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            font-size: 14px;
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: 1fr;
            }

            .search-box {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíä Gesti√≥n Farmac√©utica</h1>
            <div class="header-actions">
                <input type="text" class="search-box" id="searchInput" placeholder="üîç Buscar productos...">
                <button class="btn btn-primary" id="btnRefresh">üîÑ Actualizar</button>
                <button class="btn btn-secondary" id="btnLogout">üö™ Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div class="content-card">
            <div id="alert" class="alert"></div>

            <div class="tabs">
                <button class="tab active" data-tab="catalog">üì¶ Cat√°logo</button>
                <button class="tab" data-tab="inventory">üìä Inventario</button>
                <button class="tab" data-tab="expiring">‚è∞ Pr√≥ximos a Vencer</button>
                <button class="tab" data-tab="orders">üõí √ìrdenes</button>
            </div>

            <!-- Cat√°logo Tab -->
            <div id="catalog" class="tab-content active">
                <div class="loading" id="catalogLoading">
                    <div class="spinner"></div>
                    <p>Cargando cat√°logo...</p>
                </div>
                <div id="catalogContent"></div>
            </div>

            <!-- Inventario Tab -->
            <div id="inventory" class="tab-content">
                <div class="loading" id="inventoryLoading">
                    <div class="spinner"></div>
                    <p>Cargando inventario...</p>
                </div>
                <div id="inventoryContent"></div>
            </div>

            <!-- Pr√≥ximos a Vencer Tab -->
            <div id="expiring" class="tab-content">
                <div class="loading" id="expiringLoading">
                    <div class="spinner"></div>
                    <p>Cargando productos pr√≥ximos a vencer...</p>
                </div>
                <div id="expiringContent"></div>
            </div>

            <!-- √ìrdenes Tab -->
            <div id="orders" class="tab-content">
                <div class="loading" id="ordersLoading">
                    <div class="spinner"></div>
                    <p>Cargando √≥rdenes...</p>
                </div>
                <div id="ordersContent"></div>
            </div>
        </div>
    </div>

    <script>

        const token = sessionStorage.getItem('token');
        const username = sessionStorage.getItem('username');

        if (!token) {
            // Redirigir al login si no hay token
            window.location.href = 'index.html';
        } else {
            console.log('Usuario autenticado:', username);
            console.log('Token recuperado:', token);
        }
        // Estado de la aplicaci√≥n en memoria
        const appState = {
            token: token,
            catalogData: [],
            inventoryData: [],
            expiringData: [],
            ordersData: []
        };

        const BASE_URL = window.location.origin;

        const API_BASE = {
            auth: '/api/auth',
            catalog: '/api/catalog/catalog',
            inventory: '/api/inventory/inventory',
            inventoryExpiring: '/api/inventory/expiring',
            orders: '/api/orders/orders'
        };





        // Manejo de tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const targetTab = this.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
                
                // Cargar datos si es necesario
                if (targetTab === 'catalog' && appState.catalogData.length === 0) {
                    loadCatalog();
                } else if (targetTab === 'inventory' && appState.inventoryData.length === 0) {
                    loadInventory();
                } else if (targetTab === 'expiring' && appState.expiringData.length === 0) {
                    loadExpiring();
                } else if (targetTab === 'orders' && appState.ordersData.length === 0) {
                    loadOrders();
                }
            });
        });

        // Funci√≥n para mostrar alertas
        function showAlert(message, type = 'error') {
            const alertBox = document.getElementById('alert');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`;
            alertBox.style.display = 'block';
            
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        // Funci√≥n para obtener badge de stock
        function getStockBadge(quantity) {
            if (quantity === 0) return '<span class="stock-badge stock-out">Sin Stock</span>';
            if (quantity < 10) return '<span class="stock-badge stock-low">Stock Bajo</span>';
            if (quantity < 50) return '<span class="stock-badge stock-medium">Stock Medio</span>';
            return '<span class="stock-badge stock-high">Stock Alto</span>';
        }

        // Funci√≥n para calcular d√≠as hasta vencimiento
        function getDaysUntilExpiry(expiryDate) {
            const today = new Date();
            const expiry = new Date(expiryDate);
            const diffTime = expiry - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        async function loadCatalog() {
            document.getElementById('catalogLoading').style.display = 'block';
            document.getElementById('catalogContent').innerHTML = '';

            try {
                const [catalogRes, inventoryRes] = await Promise.all([
                    fetch(API_BASE.catalog, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(API_BASE.inventory, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);

                if (!catalogRes.ok || !inventoryRes.ok) {
                    throw new Error('Error al cargar datos');
                }

                const catalog = await catalogRes.json();
                const inventory = await inventoryRes.json();

                // Mapa de stock por SKU
                const stockMap = {};
                inventory.forEach(i => {
                    stockMap[i.sku] = i.quantity;
                });

                // Unir datos
                const mergedProducts = catalog.map(p => ({
                    ...p,
                    price: p.unit_price,                 // NORMALIZAMOS
                    available_quantity: stockMap[p.sku] || 0
                }));

                appState.catalogData = mergedProducts;
                renderCatalog(mergedProducts);

            } catch (error) {
                showAlert(error.message, 'error');
            } finally {
                document.getElementById('catalogLoading').style.display = 'none';
            }
        }



        // Renderizar Cat√°logo
        function renderCatalog(products) {
            const html = `
                <div class="products-grid">
                    ${products.map(product => {
                        const daysUntilExpiry = product.expiry_date ? getDaysUntilExpiry(product.expiry_date) : null;
                        let expiryWarning = '';
                        
                        if (daysUntilExpiry !== null) {
                            if (daysUntilExpiry <= 7) {
                                expiryWarning = `<div class="expiry-warning expiry-critical">‚ö†Ô∏è Vence en ${daysUntilExpiry} d√≠as</div>`;
                            } else if (daysUntilExpiry <= 30) {
                                expiryWarning = `<div class="expiry-warning">‚ö†Ô∏è Vence en ${daysUntilExpiry} d√≠as</div>`;
                            }
                        }

                        return `
                            <div class="product-card">
                                <div class="product-header">
                                    <div>
                                        <div class="product-name">${product.name || 'Sin nombre'}</div>
                                        <div class="product-sku">SKU: ${product.sku}</div>
                                    </div>
                                    <span class="product-category">${product.category || 'General'}</span>
                                </div>
                                <div class="product-details">
                                    <div class="detail-row">
                                        <span class="detail-label">Precio Unitario</span>
                                        <span class="detail-value price">$${product.unit_price ? product.unit_price.toFixed(2) : '0.00'}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Stock Disponible</span>
                                        <span class="detail-value">${product.available_quantity || 0} unidades</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Estado</span>
                                        ${getStockBadge(product.available_quantity || 0)}
                                    </div>
                                    ${product.next_batch ? `
                                        <div class="detail-row">
                                            <span class="detail-label">Lote Activo</span>
                                            <span class="detail-value">${product.next_batch}</span>
                                        </div>
                                    ` : ''}
                                    ${product.expiry_date ? `
                                        <div class="detail-row">
                                            <span class="detail-label">Fecha de Vencimiento</span>
                                            <span class="detail-value">${product.expiry_date}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                ${expiryWarning}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            document.getElementById('catalogContent').innerHTML = html;
        }

        async function loadInventory() {
            document.getElementById('inventoryLoading').style.display = 'block';
            document.getElementById('inventoryContent').innerHTML = '';

            try {
                const response = await fetch(API_BASE.inventory, {
                headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Error al cargar inventario');

                const data = await response.json();
                appState.inventoryData = data;

                if (data.length === 0) {
                document.getElementById('inventoryContent').innerHTML = `
                    <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <h3>No hay inventario</h3>
                    </div>`;
                } else {
                renderInventory(data);
                }
            } catch (error) {
                showAlert(error.message, 'error');
            } finally {
                document.getElementById('inventoryLoading').style.display = 'none';
            }
        }


        // Renderizar Inventario
        function renderInventory(inventory) {
            const html = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Lote</th>
                                <th>Cantidad</th>
                                <th>Fecha de Entrada</th>
                                <th>Fecha de Vencimiento</th>
                                <th>D√≠as Restantes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${inventory.map(item => {
                                const daysLeft = getDaysUntilExpiry(item.expiry_date);
                                let daysColor = '#27ae60';
                                if (daysLeft <= 7) daysColor = '#e74c3c';
                                else if (daysLeft <= 30) daysColor = '#f39c12';

                                return `
                                    <tr>
                                        <td><strong>${item.sku}</strong></td>
                                        <td>${item.batch}</td>
                                        <td>${item.quantity} unidades</td>
                                        <td>${item.entry_date || 'N/A'}</td>
                                        <td>${item.expiry_date}</td>
                                        <td style="color: ${daysColor}; font-weight: 600;">${daysLeft} d√≠as</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('inventoryContent').innerHTML = html;
        }

        async function loadExpiring() {
            document.getElementById('expiringLoading').style.display = 'block';
            document.getElementById('expiringContent').innerHTML = '';

            try {
                const response = await fetch(
                    `${API_BASE.inventory}/expiring?days=25`,
                    {
                        headers: { Authorization: `Bearer ${token}` }
                    }
                );

                if (!response.ok) throw new Error('Error al cargar vencimientos');

                const data = await response.json();

                appState.expiringData = data;

                if (!data || data.length === 0) {
                    document.getElementById('expiringContent').innerHTML = `
                        <div class="empty-state">
                            <h3>No hay productos pr√≥ximos a vencer</h3>
                        </div>`;
                } else {
                    renderExpiring(data);
                }
            } catch (error) {
                showAlert(error.message, 'error');
            } finally {
                document.getElementById('expiringLoading').style.display = 'none';
            }
        }



        // Renderizar tabla de pr√≥ximos a vencer
        function renderExpiring(products) {
            const html = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Lote</th>
                                <th>Cantidad</th>
                                <th>Fecha de Vencimiento</th>
                                <th>D√≠as Restantes</th>
                                <th>Prioridad</th>
                            </tr>
                        </thead>
                        <tbody>
                           ${products.map(item => {
                                let priorityColor = '#27ae60';

                                if (item.days_remaining <= 7) priorityColor = '#e74c3c';
                                else if (item.days_remaining <= 15) priorityColor = '#f39c12';

                                return `
                                    <tr>
                                        <td><strong>${item.sku}</strong></td>
                                        <td>${item.batch}</td>
                                        <td>${item.quantity} unidades</td>
                                        <td>${item.expiry_date}</td>
                                        <td style="color: ${priorityColor}; font-weight: 600;">
                                            ${item.days_remaining} d√≠as
                                        </td>
                                        <td style="color: ${priorityColor}; font-weight: 600;">
                                            ${item.priority}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}

                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('expiringContent').innerHTML = html;
        }

        // Cargar √ìrdenes
        async function loadOrders() {
            document.getElementById('ordersLoading').style.display = 'block';
            document.getElementById('ordersContent').innerHTML = '';

            try {
                const response = await fetch(API_BASE.orders, {
                headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Error al cargar √≥rdenes');

                const data = await response.json();
                appState.ordersData = data;

                if (data.length === 0) {
                document.getElementById('ordersContent').innerHTML = `
                    <div class="empty-state">
                    <div class="empty-state-icon">üõí</div>
                    <h3>No hay √≥rdenes</h3>
                    </div>`;
                } else {
                renderOrders(data);
                }
            } catch (error) {
                showAlert(error.message, 'error');
            } finally {
                document.getElementById('ordersLoading').style.display = 'none';
            }
            }


        // Renderizar √ìrdenes
        function renderOrders(orders) {
            const html = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>SKU</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario</th>
                                <th>Total</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orders.map(order => {
                                const price = Number(order.price ?? order.unit_price ?? 0);
                                const total = Number(order.total ?? order.total_amount ?? 0);
                                const date = order.date ?? order.created_at ?? null;

                                return `
                                    <tr>
                                        <td><strong>${order.product_name || 'N/A'}</strong></td>
                                        <td>${order.sku || '-'}</td>
                                        <td>${order.quantity ?? 0} unidades</td>
                                        <td>$${price.toFixed(2)}</td>
                                        <td style="color:#27ae60;font-weight:600;">$${total.toFixed(2)}</td>
                                        <td>${date ? new Date(date).toLocaleString('es-PE') : '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('ordersContent').innerHTML = html;
        }

        // B√∫squeda
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const activeTab = document.querySelector('.tab.active').dataset.tab;
            
            if (activeTab === 'catalog') {
                const filtered = appState.catalogData.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    p.sku.toLowerCase().includes(searchTerm)
                );
                renderCatalog(filtered);
            }
        });

        // Bot√≥n actualizar
        document.getElementById('btnRefresh').addEventListener('click', () => {
            const activeTab = document.querySelector('.tab.active').dataset.tab;
            if (activeTab === 'catalog') loadCatalog();
            else if (activeTab === 'inventory') loadInventory();
            else if (activeTab === 'expiring') loadExpiring();
            else if (activeTab === 'orders') loadOrders();
        });

      
        document.getElementById('btnLogout').addEventListener('click', () => {
            // Limpiar token y usuario de sessionStorage
            sessionStorage.removeItem('token');
            sessionStorage.removeItem('username');

            // Limpiar appState
            appState.token = null;
            appState.catalogData = [];
            appState.inventoryData = [];
            appState.expiringData = [];
            appState.ordersData = [];

            showAlert('Sesi√≥n cerrada correctamente', 'success');

            // Redirigir al login despu√©s de 1 segundo para que se vea la alerta
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        });


        // Cargar cat√°logo al inicio
        loadCatalog();
    </script>
</body>
</html>